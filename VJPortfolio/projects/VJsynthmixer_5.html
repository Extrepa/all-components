<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PsychoMath SVG Mixer</title>
  <style>
    :root { --bg:#0d1228; --panel:#121735; --ink:#eaf7ff; --accent:#7cf0ff; --accent2:#ffd36a; }
    html, body { height:100%; background:var(--bg); margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; color:var(--ink); }
    .wrap { display:grid; place-items:center; padding:24px; }
    .hint { font-size:12px; opacity:0.8; margin-top:8px; }
    svg { width: min(980px, 96vw); height: auto; border-radius:16px; box-shadow: 0 12px 40px rgba(0,0,0,.45); background: #0b1024; }
    .num { font: 600 10px/1 monospace; fill:#bcd; }
    .label { font: 700 12px/1.2 system-ui, sans-serif; fill:#cfe7ff; letter-spacing:.04em; }
    .lite { opacity:.7 }
    .tick { stroke:#2a335f; stroke-width:1 }
    .knob-face { fill:url(#faceGrad); stroke:#26305e; stroke-width:1.5 }
    .knob-cap { fill:#0b1024; stroke:#94f0ff; stroke-width:1.6 }
    .panel { fill:url(#panelGrad); stroke:#1c254f; stroke-width:1.2; rx:12; ry:12 }
    .button { cursor:pointer }
    .scope-bg { fill:#0f1433; stroke:#1e2858; stroke-width:1; rx:10; ry:10 }
    .kbd { font: 700 11px/1 monospace; fill:#8adfff }
    .led { fill:#142046; stroke:#2b3270; stroke-width:1 }
    .led.on { fill:#23d3ff }
    .btn { fill:#1a2044; stroke:#2d3a7a; stroke-width:1.2; rx:6; ry:6 }
    .btn.active { fill:#204a6a; stroke:#44a9ff }
    .small { font: 600 9px/1 monospace; fill:#9cc }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Entire UI is one SVG -->
    <svg viewBox="0 0 980 560" role="img" aria-label="PsychoMath SVG Mixer">
      <defs>
        <linearGradient id="panelGrad" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#0d1432" />
          <stop offset="1" stop-color="#0a102a" />
        </linearGradient>
        <radialGradient id="faceGrad" cx="35%" cy="30%" r="80%">
          <stop offset="0" stop-color="#172048" />
          <stop offset="1" stop-color="#0c1130" />
        </radialGradient>
        <filter id="glow">
          <feDropShadow dx="0" dy="0" stdDeviation="3" flood-color="#7cf0ff" flood-opacity=".45"/>
        </filter>
      </defs>

      <!-- Outer panel -->
      <rect class="panel" x="15" y="15" width="950" height="530" />

      <!-- Header -->
      <text x="36" y="52" class="label" font-size="22">PsychoMath Mixer</text>
      <text x="36" y="72" class="small">SVG + CSS with sprinkles of JS • knobs are rotatable • everything mathy and weird</text>

      <!-- Left: three effect viewports -->
      <!-- Spirograph -->
      <g transform="translate(30,95)">
        <rect class="scope-bg" x="0" y="0" width="420" height="140" rx="10" ry="10"/>
        <text x="12" y="18" class="label lite">Spirograph</text>
        <g id="spiroScope" transform="translate(210,75)">
          <circle r="68" fill="#0f173c" stroke="#1f2a64"/>
          <path id="spiroPath" d="" fill="none" stroke="#7cf0ff" stroke-width="1.6" filter="url(#glow)"/>
        </g>
      </g>

      <!-- Superellipse -->
      <g transform="translate(30,260)">
        <rect class="scope-bg" x="0" y="0" width="420" height="140" rx="10" ry="10"/>
        <text x="12" y="18" class="label lite">Superellipse</text>
        <g id="superScope" transform="translate(210,70)">
          <rect x="-78" y="-48" width="156" height="96" fill="#0f173c" stroke="#1f2a64"/>
          <path id="superPath" d="" fill="none" stroke="#ffd36a" stroke-width="1.6" filter="url(#glow)"/>
        </g>
      </g>

      <!-- Kaleidoscope -->
      <g transform="translate(30,425)">
        <rect class="scope-bg" x="0" y="0" width="420" height="100" rx="10" ry="10"/>
        <text x="12" y="18" class="label lite">Kaleidoscope</text>
        <g id="kaleidoScope" transform="translate(220,72)">
          <defs>
            <radialGradient id="blob" cx="30%" cy="30%">
              <stop offset="0" stop-color="#7cf0ff"/>
              <stop offset="1" stop-color="#142046"/>
            </radialGradient>
          </defs>
          <g id="kBox" transform="scale(0.8)">
            <!-- Wedges are generated by JS -->
          </g>
        </g>
      </g>

      <!-- Right: Knob strip -->
      <g id="knobStrip" transform="translate(480,95)">
        <text x="0" y="-10" class="label">Controls</text>

        <!-- Knob template instances -->
        <g class="knob" data-name="R (outer)" data-min="20" data-max="120" transform="translate(40,40)"></g>
        <g class="knob" data-name="r (inner)" data-min="5" data-max="60"  transform="translate(160,40)"></g>
        <g class="knob" data-name="d (pen)"   data-min="5" data-max="90"  transform="translate(280,40)"></g>

        <g class="knob" data-name="n (super)" data-min="2" data-max="7"   transform="translate(40,160)"></g>
        <g class="knob" data-name="Slices"    data-min="3" data-max="18"  transform="translate(160,160)"></g>
        <g class="knob" data-name="Speed"     data-min="0" data-max="1"   transform="translate(280,160)"></g>

        <!-- Buttons -->
        <g transform="translate(0,240)">
          <rect class="btn button" x="0" y="0" width="110" height="34" rx="6" ry="6" id="btnPause"/>
          <text x="12" y="22" class="kbd">Pause / Play</text>
          <rect class="led" x="120" y="8" width="10" height="18" rx="3" id="ledPlay"/>

          <rect class="btn button" x="160" y="0" width="140" height="34" rx="6" ry="6" id="btnRandomize"/>
          <text x="172" y="22" class="kbd">Randomize All</text>
        </g>
      </g>

      <!-- Footnotes -->
      <text x="482" y="420" class="small">R,r,d = Spirograph radii; n = superellipse exponent; Slices = kaleidoscope wedge count; Speed = global animation rate</text>
      <text x="482" y="440" class="small">Drag knobs (or mousewheel) to adjust. Everything is pure SVG + a dash of JS.</text>
    </svg>

    <div class="hint">Tip: print this to paper for "physical mixer" vibes, or embed the SVG directly in your Errl portal.</div>
  </div>

  <script>
  // ---------- State ----------
  const state = {
    R: 80, r: 23, d: 60,
    n: 3.5,
    slices: 8,
    speed: 0.35,
    running: true,
    t: 0
  };

  // ---------- Helpers ----------
  const $ = (q, root=document) => root.querySelector(q);
  const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
  function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
  function map(v, a1, a2, b1, b2){ return b1 + (v - a1) * (b2 - b1) / (a2 - a1); }

  // ---------- Spirograph ----------
  const spiroPath = $('#spiroPath');
  function drawSpiro(R, r, d, turns=8, steps=1200, phase=0){
    let dstr = "";
    for(let i=0;i<=steps;i++){
      const t = i/steps * (Math.PI*2*turns) + phase;
      const x = (R - r)*Math.cos(t) + d*Math.cos(((R - r)/r)*t);
      const y = (R - r)*Math.sin(t) - d*Math.sin(((R - r)/r)*t);
      dstr += (i?'L':'M') + x.toFixed(2) + "," + y.toFixed(2);
    }
    spiroPath.setAttribute('d', dstr);
    spiroPath.setAttribute('stroke', `hsl(${(state.t*40)%360} 90% 70%)`);
  }

  // ---------- Superellipse ----------
  const superPath = $('#superPath');
  function drawSuperellipse(n=3.5, a=70, b=40, steps=480){
    let dstr="";
    for(let i=0;i<=steps;i++){
      const t = i/steps * Math.PI*2;
      const ct = Math.cos(t), st = Math.sin(t);
      const x = Math.sign(ct) * a * Math.pow(Math.abs(ct), 2/n);
      const y = Math.sign(st) * b * Math.pow(Math.abs(st), 2/n);
      dstr += (i?'L':'M') + x.toFixed(2) + "," + y.toFixed(2);
    }
    superPath.setAttribute('d', dstr + "Z");
    superPath.setAttribute('stroke', `hsl(${(state.t*60+160)%360} 90% 70%)`);
  }

  // ---------- Kaleidoscope ----------
  const kBox = $('#kBox');
  function drawKaleidoscope(slices=8, t=0){
    kBox.innerHTML = "";
    const wedges = slices|0;
    const radius = 60;
    for(let i=0;i<wedges;i++){
      const ang = i*(Math.PI*2/wedges);
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("transform", `rotate(${ang*180/Math.PI})`);
      const blob = document.createElementNS("http://www.w3.org/2000/svg","path");
      const r1 = 26 + 8*Math.sin(t*0.9 + i*0.7);
      const r2 = 12 + 4*Math.cos(t*1.1 + i*0.9);
      const d = `M0,0 L0,-${radius}
                 C ${r2},-${radius-r1} ${r1},-${r2} 0,0 Z`;
      blob.setAttribute("d", d);
      blob.setAttribute("fill", `hsl(${(t*50+i*20)%360} 90% 65%)`);
      g.appendChild(blob);
      kBox.appendChild(g);
    }
  }

  // ---------- Knobs ----------
  function buildKnob(g){
    const name = g.dataset.name;
    const min = +g.dataset.min;
    const max = +g.dataset.max;
    // base
    const face = document.createElementNS("http://www.w3.org/2000/svg","circle");
    face.setAttribute("class","knob-face");
    face.setAttribute("r","28"); face.setAttribute("cx","0"); face.setAttribute("cy","0");
    g.appendChild(face);
    // ticks
    for(let i=0;i<=10;i++){
      const a = map(i,0,10,-135,135)*Math.PI/180;
      const x1 = Math.cos(a)*22, y1 = Math.sin(a)*22;
      const x2 = Math.cos(a)*26, y2 = Math.sin(a)*26;
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1",x1); line.setAttribute("y1",y1);
      line.setAttribute("x2",x2); line.setAttribute("y2",y2);
      line.setAttribute("class","tick");
      g.appendChild(line);
    }
    // pointer cap
    const cap = document.createElementNS("http://www.w3.org/2000/svg","rect");
    cap.setAttribute("class","knob-cap");
    cap.setAttribute("x","-2"); cap.setAttribute("y","-18"); cap.setAttribute("width","4"); cap.setAttribute("height","18"); cap.setAttribute("rx","2");
    cap.setAttribute("transform","rotate(-135)");
    g.appendChild(cap);
    // label
    const label = document.createElementNS("http://www.w3.org/2000/svg","text");
    label.setAttribute("class","label lite");
    label.setAttribute("x","-32"); label.setAttribute("y","48");
    label.textContent = name;
    g.appendChild(label);
    // value text
    const val = document.createElementNS("http://www.w3.org/2000/svg","text");
    val.setAttribute("class","num");
    val.setAttribute("x","-12"); val.setAttribute("y","10");
    g.appendChild(val);

    // state binding key
    const keyMap = {
      "R (outer)":"R", "r (inner)":"r", "d (pen)":"d",
      "n (super)":"n", "Slices":"slices", "Speed":"speed"
    };
    const key = keyMap[name];

    function angleFromValue(v){
      const a = map(v, min, max, -135, 135);
      return a;
    }
    function valueFromAngle(a){
      const v = map(a, -135, 135, min, max);
      return v;
    }
    // init
    function updateKnobVisual(){
      const a = angleFromValue(state[key]);
      cap.setAttribute("transform", `rotate(${a})`);
      val.textContent = (key==="speed" || key==="n") ? state[key].toFixed(2) : Math.round(state[key]);
    }
    updateKnobVisual();

    // interactions
    let dragging=false, lastA=0;
    g.style.cursor = "grab";
    g.addEventListener("pointerdown", (e)=>{
      dragging = true;
      g.setPointerCapture(e.pointerId);
      g.style.cursor = "grabbing";
    });
    g.addEventListener("pointerup", (e)=>{
      dragging = false;
      g.releasePointerCapture(e.pointerId);
      g.style.cursor = "grab";
    });
    g.addEventListener("pointermove", (e)=>{
      if(!dragging) return;
      const pt = e.currentTarget.getBoundingClientRect();
      const cx = pt.left + pt.width/2;
      const cy = pt.top + pt.height/2;
      const dx = e.clientX - cx;
      const dy = e.clientY - cy;
      let ang = Math.atan2(dy, dx) * 180/Math.PI; // -180..180
      ang = clamp(ang, -135, 135);
      const v = valueFromAngle(ang);
      state[key] = key==="n" ? +v.toFixed(2) : (key==="speed"? +v.toFixed(2) : v);
      updateKnobVisual();
      refreshOnce();
    });
    // wheel
    g.addEventListener("wheel", (e)=>{
      e.preventDefault();
      const delta = (e.deltaY<0?1:-1) * ((max-min)/100);
      state[key] = clamp(state[key] - delta, min, max);
      if(key==="n" || key==="speed") state[key] = +state[key].toFixed(2);
      updateKnobVisual();
      refreshOnce();
    }, {passive:false});
  }

  // Build all knobs
  $$('.knob').forEach(buildKnob);

  // Buttons
  const led = $('#ledPlay');
  const btnPause = $('#btnPause');
  const btnRandom = $('#btnRandomize');
  function setPlayLED(){
    if(state.running){ led.classList.add('on'); } else { led.classList.remove('on'); }
  }
  btnPause.addEventListener('click', ()=>{
    state.running = !state.running;
    setPlayLED();
  });
  btnRandom.addEventListener('click', ()=>{
    state.R = Math.round(map(Math.random(),0,1, 30,120));
    state.r = Math.round(map(Math.random(),0,1, 5,60));
    state.d = Math.round(map(Math.random(),0,1, 5,90));
    state.n = +(map(Math.random(),0,1, 2,7).toFixed(2));
    state.slices = Math.round(map(Math.random(),0,1, 3,18));
    state.speed = +(map(Math.random(),0,1, 0,1).toFixed(2));
    $$('.knob').forEach(k=>{
      // trigger visual refresh by rebuilding? simpler: call buildKnob again would duplicate elements.
      // Instead, dispatch a fake wheel to force update; easier: just call refreshOnce and knobs expose values via inner text only.
    });
    refreshOnce(true);
  });

  setPlayLED();

  // ---------- Render Loop ----------
  let rafId=0;
  function refreshOnce(force=false){
    drawSpiro(state.R, state.r, state.d, 10, 1400, state.t*0.6);
    drawSuperellipse(state.n, 80, 48, 600);
    drawKaleidoscope(state.slices, state.t);
    if(force===true){
      // also refresh knob visuals to reflect randomize
      // we stored values only; need to rotate caps again:
      $$('.knob').forEach(k=>{
        const textEl = k.querySelector('.num');
        const cap = k.querySelector('.knob-cap');
        const name = k.dataset.name;
        const min = +k.dataset.min, max = +k.dataset.max;
        const keyMap = {"R (outer)":"R","r (inner)":"r","d (pen)":"d","n (super)":"n","Slices":"slices","Speed":"speed"};
        const key = keyMap[name];
        const v = state[key];
        const angle = map(v, min,max, -135, 135);
        cap.setAttribute('transform', `rotate(${angle})`);
        textEl.textContent = (key==="speed"||key==="n") ? (+v).toFixed(2) : Math.round(v);
      });
    }
  }

  function loop(ts){
    if(state.running){
      state.t += 0.016 * (0.25 + state.speed*2.0);
      refreshOnce();
    }
    rafId = requestAnimationFrame(loop);
  }
  refreshOnce(true);
  loop(0);
  </script>
</body>
</html>
