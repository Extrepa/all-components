<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollapsingRainbowFlower</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style> body { margin: 0; padding: 0; overflow: hidden; background: #000; } canvas { display: block; } </style>
</head>
<body>
    <script>
let time = 0;
let particles = [];
const numParticles = 1000;
let noiseScale = 0.005;

class Particle {
  constructor() {
    this.pos = createVector(random(width), random(height));
    this.vel = createVector(0, 0);
    this.acc = createVector(0, 0);
    this.maxSpeed = 2;
    this.history = [];
    this.hue = random(360);
  }

  update(t) {
    let angle = noise(this.pos.x * noiseScale, this.pos.y * noiseScale, t) * TWO_PI * 4;
    let force = p5.Vector.fromAngle(angle);
    force.setMag(0.2);
    this.acc.add(force);

    this.vel.add(this.acc);
    this.vel.limit(this.maxSpeed);
    this.pos.add(this.vel);
    this.acc.mult(0);
    
    this.history.push(this.pos.copy());
    if (this.history.length > 20) {
      this.history.splice(0, 1);
    }
  }

  display(t) {
    noFill();
    beginShape();
    for (let i = 0; i < this.history.length; i++) {
      let h = (this.hue + t * 30 + i * 2) % 360;
      let s = 90;
      let b = 100;
      let a = map(i, 0, this.history.length, 0, 80);
      stroke(h, s, b, a);
      strokeWeight(map(i, 0, this.history.length, 1, 3));
      vertex(this.history[i].x, this.history[i].y);
    }
    endShape();
  }

  edges() {
    if (this.pos.x > width + 10) {
      this.pos.x = -10;
      this.history = [];
    }
    if (this.pos.x < -10) {
      this.pos.x = width + 10;
      this.history = [];
    }
    if (this.pos.y > height + 10) {
      this.pos.y = -10;
      this.history = [];
    }
    if (this.pos.y < -10) {
      this.pos.y = height + 10;
      this.history = [];
    }
  }
}


function setup() {
  createCanvas(800, 600);
  colorMode(HSB, 360, 100, 100, 100);
  for (let i = 0; i < numParticles; i++) {
    particles.push(new Particle());
  }
  background(0);
}

function draw() {
  // Feedback effect
  fill(0, 0, 0, 5);
  noStroke();
  rect(0, 0, width, height);

  time += 0.01;

  // Update and display particles
  for (let p of particles) {
    p.update(time);
    p.display(time);
    p.edges();
  }
  
  // Draw the central psychedelic iris/portal
  drawPortal();
}

function drawPortal() {
  push();
  translate(width / 2, height / 2);

  let mouseFactor = map(dist(mouseX, mouseY, width / 2, height / 2), 0, width / 2, 0.5, 3);

  for (let i = 25; i > 0; i--) {
    let radius = i * 25;
    let hue = (frameCount + i * 10) % 360;
    
    fill(hue, 90, 100, 15);
    noStroke();

    beginShape();
    for (let angle = 0; angle < 360; angle += 4) {
      let offset = map(noise(i * 0.1, angle * 0.02, time * 0.8), 0, 1, -80, 80) * mouseFactor;
      let r = radius + offset;
      let x = r * cos(radians(angle));
      let y = r * sin(radians(angle));
      curveVertex(x, y);
      
      if(i % 5 === 0) { // Add some extra flare
        let flareR = r + sin(angle * 6 + time * 10) * 20;
        let flareX = flareR * cos(radians(angle));
        let flareY = flareR * sin(radians(angle));
        stroke(hue, 50, 100, 20);
        strokeWeight(1);
        line(x, y, flareX, flareY);
      }
    }
    endShape(CLOSE);
  }
  pop();
}
    </script>
</body>
</html>
