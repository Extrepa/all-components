<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrippyPurpleWaves_Gemini</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style> body { margin: 0; padding: 0; overflow: hidden; background: #000; } canvas { display: block; } </style>
</head>
<body>
    <script>
let particles = [];
const numParticles = 2000;
let t = 0;

class Particle {
  constructor() {
    this.pos = createVector(random(width), random(height));
    this.vel = createVector(0, 0);
    this.acc = createVector(0, 0);
    this.maxSpeed = 3;
    this.h = random(360);
    this.lifespan = 255;
  }

  update(noiseScale, noiseStrength) {
    let angle = noise(this.pos.x * noiseScale, this.pos.y * noiseScale, t * 0.2) * TWO_PI * 4;
    let force = p5.Vector.fromAngle(angle);
    force.mult(noiseStrength);
    this.acc.add(force);

    this.vel.add(this.acc);
    this.vel.limit(this.maxSpeed);
    this.pos.add(this.vel);
    this.acc.mult(0);
    this.lifespan -= 0.5;
  }

  respawn() {
    if (this.pos.x > width || this.pos.x < 0 || this.pos.y > height || this.pos.y < 0 || this.lifespan < 0) {
      this.pos = createVector(random(width), random(height));
      this.vel.mult(0);
      this.lifespan = 255;
      this.h = (t * 20 + random(-20, 20)) % 360;
    }
  }

  show() {
    strokeWeight(1.5);
    stroke(this.h, 90, 100, this.lifespan / 255 * 0.7);
    line(this.pos.x, this.pos.y, this.pos.x - this.vel.x * 2, this.pos.y - this.vel.y * 2);
  }
}

function setup() {
  createCanvas(800, 600);
  colorMode(HSB, 360, 100, 100, 1);
  background(0);
  for (let i = 0; i < numParticles; i++) {
    particles.push(new Particle());
  }
  strokeCap(ROUND);
}

function draw() {
  blendMode(BLEND);
  background(0, 0, 0, 0.05);
  blendMode(ADD);

  t += 0.01;

  // Layer 1: Central Pulsing Amoeba
  translate(width / 2, height / 2);
  let numPoints = 120;
  let radius = map(sin(t), -1, 1, 100, 300);
  let blobHue = (t * 30) % 360;
  strokeWeight(1);
  stroke(blobHue, 80, 100, 0.15);
  noFill();

  beginShape();
  for (let i = 0; i < numPoints + 3; i++) {
    let angle = map(i, 0, numPoints, 0, TWO_PI);
    let noiseFactor = map(mouseY, 0, height, 0.1, 2);
    let offset = map(noise(cos(angle) * noiseFactor + 1, sin(angle) * noiseFactor + 1, t), 0, 1, -150, 150);
    let r = radius + offset;
    let x = r * cos(angle);
    let y = r * sin(angle);
    curveVertex(x, y);
  }
  endShape();
  resetMatrix();


  // Layer 2: Kaleidoscopic Mandala
  translate(width / 2, height / 2);
  let segments = 10 + floor(map(mouseX, 0, width, -4, 4));
  for (let i = 0; i < segments; i++) {
    rotate(TWO_PI / segments);
    drawMandalaArm();
  }
  resetMatrix();


  // Layer 3: Particle Flow Field
  let noiseScale = 0.003;
  let noiseStrength = map(sin(t * 0.5), -1, 1, 0.1, 0.5);
  for (let p of particles) {
    p.update(noiseScale, noiseStrength);
    p.respawn();
    p.show();
  }
}

function drawMandalaArm() {
  let layers = 5;
  for (let j = 1; j <= layers; j++) {
    push();
    let scaleFactor = j * 0.2;
    scale(scaleFactor);
    rotate(t * (j % 2 == 0 ? -1 : 1) * 0.5);

    let hue = (t * 40 + j * 30) % 360;
    let sat = map(sin(t * 2 + j), -1, 1, 60, 100);
    let brt = map(cos(t * 3 - j), -1, 1, 80, 100);
    let alpha = map(j, 1, layers, 0.6, 0.1);
    
    stroke(hue, sat, brt, alpha);
    strokeWeight(map(j, 1, layers, 3, 1) / scaleFactor); // Keep stroke weight consistent
    noFill();

    let r1 = 100;
    let r2 = 400;
    let amp = 80;
    let freq = 0.02 + map(mouseX, 0, width, -0.01, 0.01);

    beginShape();
    for (let r = r1; r < r2; r += 8) {
      let angleOffset = sin(r * freq - t * 3) * amp * (r / r2);
      vertex(r, angleOffset);
    }
    endShape();

    // Add some circles
    fill(hue, sat, brt, alpha * 0.05);
    let circ_r = r1 + map(sin(t*2+j), -1, 1, 0, (r2-r1)*0.5);
    let circ_a_off = sin(circ_r * freq - t * 3) * amp * (circ_r/r2);
    circle(circ_r, circ_a_off, 30 / scaleFactor);
    
    pop();
  }
}
    </script>
</body>
</html>
